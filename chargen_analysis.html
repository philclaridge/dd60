<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DD60 Character Generator Analysis</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #f0f0f0;
        }
        h1 {
            color: #333;
        }
        .char-section {
            background: white;
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .char-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #0066cc;
        }
        table {
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 4px 8px;
            text-align: center;
        }
        th {
            background: #e0e0e0;
            font-weight: bold;
        }
        .beam-on {
            background: #90EE90;
        }
        .beam-off {
            background: #FFE0E0;
        }
        .error {
            background: #FF6B6B;
            color: white;
            font-weight: bold;
        }
        .summary {
            background: #fffacd;
            padding: 10px;
            margin: 20px 0;
            border-left: 4px solid #ff9900;
        }
        .grid-canvas {
            border: 1px solid #999;
            margin: 10px 0;
            display: inline-block;
        }
    </style>
</head>
<body>
    <h1>DD60 Character Generator Analysis</h1>
    <p>Analysis of CDC 6602 character patterns using authentic binary ROM format (cdcRomBinary.js)<br>
    Binary data is decoded at runtime to vector coordinates showing delta movements between strokes</p>
    
    <div class="summary">
        <h2>Summary</h2>
        <p>Total characters analyzed: <span id="totalChars">0</span></p>
        <p>Characters with violations (|Δ| > 2): <span id="violationCount">0</span></p>
        <p>Total violations found: <span id="totalViolations">0</span></p>
    </div>

    <div id="output"></div>

    <script type="module">
        // Import the CDC ROM binary data and conversion functions
        import { cdcRomBinary } from './src/chargen/cdcRomBinary.js';
        import { binaryToVector } from './src/chargen/cdcRomFunctions.js';
        
        // Generate the vector ROM at runtime from binary data
        const vectorCharacterRomCDC6602 = {};
        for (const [char, binaryData] of Object.entries(cdcRomBinary)) {
            vectorCharacterRomCDC6602[char] = binaryToVector(binaryData);
        }

        function analyzeCharacter(charCode, strokes) {
            const deltas = [];
            const violations = [];
            
            for (let i = 0; i < strokes.length; i++) {
                const current = strokes[i];
                let deltaX = 0, deltaY = 0;
                
                if (i > 0) {
                    const prev = strokes[i - 1];
                    deltaX = current[0] - prev[0];
                    deltaY = current[1] - prev[1];
                    
                    // Check for violations
                    if (Math.abs(deltaX) > 2 || Math.abs(deltaY) > 2) {
                        violations.push({
                            step: i,
                            deltaX: deltaX,
                            deltaY: deltaY,
                            from: [prev[0], prev[1]],
                            to: [current[0], current[1]]
                        });
                    }
                }
                
                deltas.push({
                    step: i,
                    x: current[0],
                    y: current[1],
                    beam: current[2],
                    deltaX: deltaX,
                    deltaY: deltaY,
                    violation: Math.abs(deltaX) > 2 || Math.abs(deltaY) > 2
                });
            }
            
            return { deltas, violations };
        }

        function drawCharacterGrid(strokes, canvasId, scale = 20) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 8; i++) {
                ctx.beginPath();
                ctx.moveTo(i * scale, 0);
                ctx.lineTo(i * scale, 8 * scale);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, i * scale);
                ctx.lineTo(8 * scale, i * scale);
                ctx.stroke();
            }
            
            // Draw character strokes
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            let prevBeam = false;
            
            for (let i = 0; i < strokes.length; i++) {
                const [x, y, beam] = strokes[i];
                const px = x * scale + scale/2;
                const py = (7 - y) * scale + scale/2; // Flip Y axis for display
                
                if (i > 0 && prevBeam && beam) {
                    const [prevX, prevY] = strokes[i-1];
                    const ppx = prevX * scale + scale/2;
                    const ppy = (7 - prevY) * scale + scale/2;
                    
                    ctx.beginPath();
                    ctx.moveTo(ppx, ppy);
                    ctx.lineTo(px, py);
                    ctx.stroke();
                }
                
                // Draw point
                ctx.fillStyle = beam ? '#00ff00' : '#ff0000';
                ctx.beginPath();
                ctx.arc(px, py, 3, 0, 2 * Math.PI);
                ctx.fill();
                
                prevBeam = beam;
            }
        }

        function createCharacterHTML(charCode, analysis) {
            const { deltas, violations } = analysis;
            const binaryData = cdcRomBinary[charCode];
            
            let html = `
                <div class="char-section">
                    <div class="char-header">Character: '${charCode}'</div>
                    <details style="margin: 10px 0;">
                        <summary style="cursor: pointer; font-weight: bold;">Binary Data (click to expand)</summary>
                        <div style="font-family: monospace; font-size: 11px; background: #f8f8f8; padding: 10px; margin-top: 5px;">
                            ${binaryData.map((val, i) => {
                                const bits = val.toString(2).padStart(5, '0');
                                const label = i === 0 ? '76' : (i-1).toString(8).padStart(2, '0');
                                const v1v2 = bits.substr(0,2);
                                const h1h2 = bits.substr(2,2);
                                const u = bits[4];
                                return `T=${label}: 0b${bits} (${v1v2}.${h1h2}.${u})`;
                            }).join('<br>')}
                        </div>
                    </details>
                    <canvas id="canvas-${charCode}" class="grid-canvas" width="180" height="180"></canvas>
                    <table>
                        <tr>
                            <th>Step</th>
                            <th>X</th>
                            <th>Y</th>
                            <th>Beam</th>
                            <th>ΔX</th>
                            <th>ΔY</th>
                            <th>|Δ|</th>
                        </tr>
            `;
            
            deltas.forEach(d => {
                const maxDelta = Math.max(Math.abs(d.deltaX), Math.abs(d.deltaY));
                const rowClass = d.violation ? 'error' : (d.beam ? 'beam-on' : 'beam-off');
                html += `
                    <tr class="${rowClass}">
                        <td>${d.step}</td>
                        <td>${d.x}</td>
                        <td>${d.y}</td>
                        <td>${d.beam ? '✓' : '✗'}</td>
                        <td>${d.step > 0 ? (d.deltaX >= 0 ? '+' : '') + d.deltaX : '-'}</td>
                        <td>${d.step > 0 ? (d.deltaY >= 0 ? '+' : '') + d.deltaY : '-'}</td>
                        <td>${d.step > 0 ? maxDelta : '-'}</td>
                    </tr>
                `;
            });
            
            html += `</table>`;
            
            if (violations.length > 0) {
                html += `<div class="error" style="padding: 10px; margin-top: 10px;">
                    ⚠️ VIOLATIONS FOUND: ${violations.length} steps exceed maximum delta of 2 units
                    <ul>`;
                violations.forEach(v => {
                    html += `<li>Step ${v.step}: [${v.from}] → [${v.to}] (ΔX=${v.deltaX}, ΔY=${v.deltaY})</li>`;
                });
                html += `</ul></div>`;
            }
            
            html += `</div>`;
            return html;
        }

        // Main analysis
        const output = document.getElementById('output');
        let totalViolations = 0;
        let charsWithViolations = 0;
        let totalChars = 0;

        // Sort characters for display
        const charOrder = '0123456789 ABCDEFGHIJKLMNOPQRSTUVWXYZ+-*/()=,.';
        const sortedChars = Object.keys(vectorCharacterRomCDC6602).sort((a, b) => {
            const indexA = charOrder.indexOf(a);
            const indexB = charOrder.indexOf(b);
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
            return indexA - indexB;
        });

        sortedChars.forEach(charCode => {
            const strokes = vectorCharacterRomCDC6602[charCode];
            const analysis = analyzeCharacter(charCode, strokes);
            
            totalChars++;
            if (analysis.violations.length > 0) {
                charsWithViolations++;
                totalViolations += analysis.violations.length;
            }
            
            output.innerHTML += createCharacterHTML(charCode, analysis);
            
            // Draw the character after adding HTML
            setTimeout(() => {
                drawCharacterGrid(strokes, `canvas-${charCode}`);
            }, 0);
        });

        // Update summary
        document.getElementById('totalChars').textContent = totalChars;
        document.getElementById('violationCount').textContent = charsWithViolations;
        document.getElementById('totalViolations').textContent = totalViolations;

        // Add final status
        if (totalViolations === 0) {
            output.innerHTML = `
                <div style="background: #90EE90; padding: 20px; margin: 20px 0; border-radius: 5px; font-size: 18px; text-align: center;">
                    ✓ ALL CHARACTERS PASS: No delta violations found (all |Δ| ≤ 2)
                </div>
            ` + output.innerHTML;
        } else {
            output.innerHTML = `
                <div style="background: #FF6B6B; color: white; padding: 20px; margin: 20px 0; border-radius: 5px; font-size: 18px; text-align: center;">
                    ✗ VIOLATIONS FOUND: ${totalViolations} steps exceed maximum delta in ${charsWithViolations} characters
                </div>
            ` + output.innerHTML;
        }
    </script>
</body>
</html>